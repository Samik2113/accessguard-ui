name: Deploy Azure Function App (Direct Kudu Zip Deploy)

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Functions (backend)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Functions project root
        run: |
          if [ ! -f "backend/host.json" ]; then
            echo "Error: backend/host.json not found."
            exit 1
          fi

      - name: Create deployment package
        run: |
          cd backend
          zip -r ../backend.zip .

      - name: Extract publish profile values (Bash only)
        id: prep
        run: |
          echo "${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}" > profile.xml

          # Extract attributes manually using bash/grep/sed
          USER=$(grep -oP 'userName="\K[^"]+' profile.xml | head -1)
          PASS=$(grep -oP 'userPWD="\K[^"]+' profile.xml | head -1)
          PUBLISH_URL=$(grep -oP 'publishUrl="\K[^"]+' profile.xml | head -1)

          # Strip :443 and anything after the hostname
          HOST=$(echo "$PUBLISH_URL" | sed 's/:443.*//')

          KUDU_URL="https://${HOST}/api/zipdeploy"

          echo "::add-mask::$USER"
          echo "::add-mask::$PASS"

          echo "user=$USER" >> $GITHUB_OUTPUT
          echo "pass=$PASS" >> $GITHUB_OUTPUT
          echo "kudu_url=$KUDU_URL" >> $GITHUB_OUTPUT

      - name: Deploy to Kudu (Zip Deploy)
        run: |
          echo "Deploying to: ${{ steps.prep.outputs.kudu_url }}"
          STATUS=$(curl -s -o response.json -w "%{http_code}" \
            -u "${{ steps.prep.outputs.user }}:${{ steps.prep.outputs.pass }}" \
            -X POST \
            -H "Content-Type: application/zip" \
            --data-binary @backend.zip \
            "${{ steps.prep.outputs.kudu_url }}")

          echo "HTTP Status: $STATUS"
          cat response.json || true

          if [ "$STATUS" != "200" ] && [ "$STATUS" != "202" ]; then
            echo "Deployment FAILED"
            exit 1
          fi

          echo "Deployment started successfully."