
name: Deploy Azure Function App (FTP Run From Package)

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Verify backend root
      shell: pwsh
      run: |
        if (-Not (Test-Path "backend/host.json")) {
          Write-Error "backend/host.json missing"
        }

    - name: Zip backend
      shell: pwsh
      run: |
        Compress-Archive -Path backend\* -DestinationPath backend.zip -Force

    - name: FTP Deploy Package
      shell: pwsh
      env:
        FTP_USER: ${{ secrets.FTP_USER }}
        FTP_PASS: ${{ secrets.FTP_PASS }}
        FTP_HOST: ${{ secrets.FTP_HOST }}
      run: |
        $ftp = "ftp://$($env:FTP_HOST)/site/wwwroot/"

        Write-Host "Uploading backend.zip to $ftp"

        $wc = New-Object System.Net.WebClient
        $wc.Credentials = New-Object System.Net.NetworkCredential($env:FTP_USER, $env:FTP_PASS)
        $wc.UploadFile("$ftp/backend.zip", "backend.zip")

    - name: Set WEBSITE_RUN_FROM_PACKAGE
      shell: pwsh
      env:
        AZURE_FUNC_NAME: "func-accessguard-dev"
        AZURE_WEBAPP_PUBLISH_PROFILE: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE }}
      run: |
        Install-Module -Name Az.Websites -Force -Scope CurrentUser -AllowClobber
        $pp = $env:AZURE_WEBAPP_PUBLISH_PROFILE
        [xml]$xml = $pp
        $user = $xml.publishData.publishProfile[0].userName
        $pwd = $xml.publishData.publishProfile[0].userPWD

        az login --username $user --password $pwd --allow-no-subscriptions

        az functionapp config appsettings set `
          --name func-accessguard-dev `
          --resource-group rg-uar-core-dev `
          --settings "WEBSITE_RUN_FROM_PACKAGE=1"
